<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prime Broker Dashboard</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script> 
    
    <style>
        /* Prime Video Aesthetic */
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #000; color: #E5E5E5; margin: 0; padding: 0; }
        .header { background-color: #19232D; padding: 15px 30px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.5); }
        .header h1 { margin: 0; color: #FF9900; font-size: 28px; }
        .user-info { display: flex; align-items: center; }
        .user-info span { margin-right: 20px; font-weight: 500; }
        
        .user-data { display: flex; gap: 40px; }
        .data-box { text-align: left; }
        .data-box label { font-size: 12px; color: #999; display: block; margin-bottom: 2px;}
        .data-box span { font-size: 20px; font-weight: bold; color: #fff; }

        .logout-btn { background-color: #CC7A00; color: #fff; padding: 8px 15px; border: none; border-radius: 4px; cursor: pointer; text-decoration: none; transition: background-color 0.3s; }
        .logout-btn:hover { background-color: #FF9900; }
        
        .container { padding: 30px; }
        
        .section-title { color: #fff; border-bottom: 1px solid #333; padding-bottom: 10px; margin-bottom: 25px; font-size: 20px; font-weight: 500; }
        
        .stock-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; }
        
        .stock-card { 
            background-color: #19232D; padding: 25px; border-radius: 8px; border-left: 3px solid #FF9900;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.4); transition: transform 0.2s; position: relative; 
        }
        .stock-card:hover { transform: translateY(-5px); box-shadow: 0 6px 15px rgba(255, 153, 0, 0.2); }
        
        .stock-ticker { font-size: 28px; font-weight: bold; margin-bottom: 5px; color: #FF9900; }
        .stock-price { font-size: 38px; font-weight: bolder; margin-bottom: 15px; }
        
        /* Price change animation and color coding */
        .price-up { color: #4CAF50; } /* Green */
        .price-down { color: #F44336; } /* Red */
        .price-unchanged { color: #E5E5E5; } 

        .pulse { animation: pulse-animation 0.5s ease-out; }
        @keyframes pulse-animation {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.03); opacity: 0.9; }
            100% { transform: scale(1); opacity: 1; }
        }
        
        .holding-details { font-size: 14px; margin-top: 10px; border-top: 1px dashed #333; padding-top: 10px; }
        .holding-details p { margin: 5px 0; display: flex; justify-content: space-between;}
        .holding-details .value-label { color: #999; }
        .holding-details .quantity { color: #FF9900; font-weight: bold; }
        .holding-details .pl { font-weight: bold; }
        .pl-positive { color: #4CAF50; }
        .pl-negative { color: #F44336; }
        .ta-value { color: #64B5F6; font-weight: bold; }

        .trade-buttons { display: flex; justify-content: space-between; margin-top: 20px; }
        .trade-btn { padding: 10px; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; font-weight: bold; width: 48%; }
        .buy-btn { background-color: #4CAF50; color: white; transition: background-color 0.2s; }
        .buy-btn:hover { background-color: #388E3C; }
        .sell-btn { background-color: #F44336; color: white; transition: background-color 0.2s; }
        .sell-btn:hover { background-color: #D32F2F; }

        /* Trade Form Modal */
        .trade-form {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(0, 0, 0, 0.95); 
            display: none; flex-direction: column; justify-content: center; align-items: center;
            border-radius: 8px; padding: 20px; z-index: 10;
        }
        .stock-card.active .trade-form { display: flex; }
        .trade-form input[type="number"] {
            width: 80%; padding: 10px; margin-bottom: 15px; border-radius: 4px; border: 1px solid #FF9900;
            background-color: #2F3B48; color: white; text-align: center; font-size: 16px;
        }

        .chart-grid { display: grid; grid-template-columns: 1fr; gap: 20px; margin-top: 20px; }
        .chart-container { background-color: #19232D; padding: 25px; border-radius: 8px; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.4); }
        .chart-container h3 { color: #FF9900; margin-top: 0; }

    </style>
</head>
<body>
    <div class="header">
        <h1>Prime Broker</h1>
        <div class="user-data">
            <div class="data-box">
                <label>Total Value</label>
                <span id="total-value">--</span>
            </div>
            <div class="data-box">
                <label>Cash Balance</label>
                <span id="cash-balance">--</span>
            </div>
        </div>
        <div class="user-info">
            <span>{{ user_email }}</span>
            <a href="{{ url_for('logout') }}" class="logout-btn">Sign Out</a>
        </div>
    </div>
    
    <div class="container">
        
        <h2 class="section-title">My Portfolio & Live Trading</h2>
        <div class="stock-list" id="subscribed-stocks">
            {% for ticker in subscribed_stocks %}
            <div class="stock-card" data-ticker="{{ ticker }}">
                <div class="stock-ticker">{{ ticker }}</div>
                <div class="stock-price price-unchanged" id="price-{{ ticker }}">...</div>
                
                <div class="holding-details" id="holding-{{ ticker }}">
                    <p><span class="value-label">Quantity:</span> <span class="quantity">0</span></p>
                    <p><span class="value-label">SMA(20):</span> <span class="ta-value" id="sma-{{ ticker }}">N/A</span></p>
                    <p><span class="value-label">P&L:</span> <span class="pl">N/A</span></p>
                </div>
                
                <div class="trade-buttons">
                    <button class="trade-btn buy-btn" onclick="showTradeForm('{{ ticker }}', 'BUY')">BUY</button>
                    <button class="trade-btn sell-btn" onclick="showTradeForm('{{ ticker }}', 'SELL')">SELL</button>
                </div>

                <form method="POST" action="{{ url_for('trade') }}" class="trade-form" id="form-{{ ticker }}">
                    <input type="hidden" name="ticker" value="{{ ticker }}">
                    <input type="hidden" name="action" id="action-{{ ticker }}">
                    <input type="number" name="quantity" placeholder="Quantity (Shares)" required min="1">
                    <button type="submit" class="trade-btn buy-btn" id="submit-btn-{{ ticker }}">CONFIRM TRADE</button>
                    <button type="button" class="trade-btn sell-btn" onclick="hideTradeForm('{{ ticker }}')">CANCEL</button>
                </form>

            </div>
            {% else %}
            <p>You have no subscribed stocks. Use the section below to add some to your watch list, or buy a stock to start your portfolio!</p>
            {% endfor %}
        </div>

        <h2 class="section-title" style="margin-top: 40px;">Portfolio Allocation</h2>
        <div class="chart-grid">
            <div class="chart-container" style="max-width: 500px; margin: 0 auto;">
                <h3>Current Asset Allocation</h3>
                <canvas id="portfolioPieChart" style="max-height: 400px;"></canvas>
            </div>
        </div>


        <h2 class="section-title" style="margin-top: 40px;">Available Stocks (Watch List)</h2>
        <div class="stock-list">
            {% for ticker in available_stocks %}
                {% if ticker not in subscribed_stocks %}
                    <div class="stock-card" style="border-left: 3px solid #64B5F6;">
                        <div class="stock-ticker">{{ ticker }}</div>
                        <div class="holding-details">
                            <p>Available to watch.</p>
                        </div>
                        <div class="trade-buttons">
                             <a href="{{ url_for('subscribe', ticker=ticker) }}" class="trade-btn buy-btn" style="width:100%;">Add to Watch List</a>
                        </div>
                    </div>
                {% endif %}
            {% endfor %}
        </div>
    </div>

    <script>
        const socket = io();
        const subscribedTickers = [
            {% for ticker in subscribed_stocks %}'{{ ticker }}',{% endfor %}
        ];
        
        let pieChart;
        
        // --- Trade Form Logic ---
        function showTradeForm(ticker, action) {
            // Hide all other trade forms
            document.querySelectorAll('.stock-card.active').forEach(card => card.classList.remove('active'));
            
            const card = document.querySelector(`.stock-card[data-ticker="${ticker}"]`);
            const actionInput = document.getElementById(`action-${ticker}`);
            const submitBtn = document.getElementById(`submit-btn-${ticker}`);

            actionInput.value = action;
            submitBtn.textContent = `${action} STOCK`;
            submitBtn.className = `trade-btn ${action === 'BUY' ? 'buy-btn' : 'sell-btn'}`;
            
            card.classList.add('active');
        }

        function hideTradeForm(ticker) {
            const card = document.querySelector(`.stock-card[data-ticker="${ticker}"]`);
            card.classList.remove('active');
        }

        // --- 1. Initialize Pie Chart ---
        const pieChartCtx = document.getElementById('portfolioPieChart');
        if (pieChartCtx) {
             pieChart = new Chart(pieChartCtx, {
                type: 'doughnut', 
                data: {
                    labels: [],
                    datasets: [{
                        data: [],
                        backgroundColor: ['#FF9900', '#4CAF50', '#64B5F6', '#F44336', '#A171F8', '#CC7A00'], // Prime-style colors
                        hoverOffset: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: {
                        duration: 1000, // Smooth 1-second animation for trade updates
                        easing: 'easeInOutQuart'
                    },
                    plugins: { 
                        legend: { position: 'right', labels: { color: '#E5E5E5' } },
                        title: {
                            display: false
                        }
                    }
                }
            });
        }
        
        // --- 2. SocketIO Listener for Real-Time Data ---
        socket.on('real_time_data', function(data) {
            const currentPrices = data.prices;
            const analysis = data.analysis;
            const portfolio = data.portfolio['{{ user_email }}'];

            if (portfolio) {
                // A) Update Header Data
                document.getElementById('cash-balance').textContent = `$${portfolio.cash_balance.toFixed(2)}`;
                document.getElementById('total-value').textContent = `$${portfolio.total_value.toFixed(2)}`;
            }

            // B) Update Price, Holdings, and P&L for Stock Cards
            subscribedTickers.forEach(ticker => {
                const newPrice = currentPrices[ticker];
                const priceElement = document.getElementById(`price-${ticker}`);
                const holdingElement = document.getElementById(`holding-${ticker}`);
                const smaElement = document.getElementById(`sma-${ticker}`);
                
                if (priceElement && newPrice !== undefined) {
                    const oldPrice = parseFloat(priceElement.textContent);
                    let priceClass = 'price-unchanged';
                    
                    if (!isNaN(oldPrice)) {
                        if (newPrice > oldPrice) { priceClass = 'price-up'; } 
                        else if (newPrice < oldPrice) { priceClass = 'price-down'; }
                    }

                    // 1. Update Real-Time Price with Pulse Animation
                    priceElement.textContent = newPrice.toFixed(2);
                    priceElement.className = `stock-price ${priceClass}`;
                    priceElement.classList.add('pulse');
                    setTimeout(() => { priceElement.classList.remove('pulse'); }, 500);

                    // 2. Update SMA
                    if (smaElement && analysis[ticker]) {
                        smaElement.textContent = analysis[ticker].sma_20;
                    }

                    // 3. Update Holdings and P&L (Simulated)
                    const holdingData = portfolio.holdings[ticker];

                    if (holdingElement) {
                        const quantitySpan = holdingElement.querySelector('.quantity');
                        const plSpan = holdingElement.querySelector('.pl');
                        
                        let quantity = 0;
                        let plText = 'N/A';
                        let plClass = '';
                        let simulatedPL = 0;

                        if (holdingData) {
                            quantity = holdingData.quantity;
                            
                            // *** SIMULATED P/L CALCULATION ***
                            // A real app would use (CurrentPrice - CostBasis) * Quantity
                            // We use the P/L value calculated in the backend for the overall portfolio for simplicity.
                            if (ticker === 'GOOG' || ticker === 'TSLA') { // Example: use a fixed dummy cost basis
                                const dummyCostBasis = 450;
                                simulatedPL = (newPrice - dummyCostBasis) * quantity;
                            } else {
                                simulatedPL = (newPrice - 600) * quantity;
                            }
                            
                            plText = `${simulatedPL >= 0 ? '+' : ''}$${simulatedPL.toFixed(2)}`;
                            plClass = simulatedPL >= 0 ? 'pl-positive' : 'pl-negative';
                        }
                        
                        quantitySpan.textContent = quantity;
                        plSpan.textContent = plText;
                        plSpan.className = `pl ${plClass}`;
                    }
                }
            });
            
            // C) Update Portfolio Pie Chart
            if (pieChart && portfolio) {
                const labels = [];
                const values = [];
                const colors = ['#FF9900', '#4CAF50', '#64B5F6', '#F44336', '#A171F8', '#CC7A00'];
                let colorIndex = 0;
                
                // 1. Add Cash Balance as a segment
                if (portfolio.cash_balance > 0) {
                    labels.push('Cash');
                    values.push(portfolio.cash_balance);
                    // Note: Chart.js will automatically match data point to color array
                }

                // 2. Add Stock Holdings
                for (const ticker in portfolio.holdings) {
                    const holding = portfolio.holdings[ticker];
                    if (holding.current_value > 0) {
                        labels.push(ticker);
                        values.push(holding.current_value);
                    }
                }

                pieChart.data.labels = labels;
                pieChart.data.datasets[0].data = values;
                pieChart.update(); // Chart.js handles the smooth animation (duration set in options)
            }
        });
        
        socket.on('connect', function() {
            console.log('Connected to the server via WebSocket!');
        });
    </script>
</body>
</html>
